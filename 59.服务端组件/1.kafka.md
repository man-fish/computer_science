## ä»€ä¹ˆå«æ¶ˆæ¯é˜Ÿåˆ—ğŸ’©

æ¶ˆæ¯ï¼ˆ`Message`ï¼‰æ˜¯æŒ‡åœ¨åº”ç”¨é—´ä¼ é€çš„æ•°æ®ã€‚æ¶ˆæ¯å¯ä»¥éå¸¸ç®€å•ï¼Œæ¯”å¦‚åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ›´å¤æ‚ï¼Œå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚

æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ`Message Queue`ï¼‰æ˜¯ä¸€ç§åº”ç”¨é—´çš„é€šä¿¡æ–¹å¼ï¼Œæ¶ˆæ¯å‘é€åå¯ä»¥ç«‹å³è¿”å›ï¼Œç”±æ¶ˆæ¯ç³»ç»Ÿæ¥ç¡®ä¿æ¶ˆæ¯çš„å¯é ä¼ é€’ã€‚æ¶ˆæ¯å‘å¸ƒè€…åªç®¡æŠŠæ¶ˆæ¯å‘å¸ƒåˆ° `MQ` ä¸­è€Œä¸ç”¨ç®¡è°æ¥å–ï¼Œæ¶ˆæ¯ä½¿ç”¨è€…åªç®¡ä» MQ ä¸­å–æ¶ˆæ¯è€Œä¸ç®¡æ˜¯è°å‘å¸ƒçš„ã€‚è¿™æ ·å‘å¸ƒè€…å’Œä½¿ç”¨è€…éƒ½ä¸ç”¨çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ï¼Œä»–ä»¬å…±äº«çš„åªæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„åç§°è€Œå·²ã€‚

## ä¸ºä½•ç”¨æ¶ˆæ¯é˜Ÿåˆ—ğŸ—¾

### å¼‚æ­¥å¤„ç†

å‚ç…§ä¸‹å›¾åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—æŠŠä¸šåŠ¡æµç¨‹ä¸­çš„éå…³é”®æµç¨‹å¼‚æ­¥åŒ–ï¼Œä»è€Œæ˜¾è‘—é™ä½ä¸šåŠ¡è¯·æ±‚çš„å“åº”æ—¶é—´ã€‚

![nsqåº”ç”¨åœºæ™¯1](http://image.innoweb.cn/2020-02-07-190627.png)

### åº”ç”¨è§£è€¦

é€šè¿‡ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å°†ä¸åŒçš„ä¸šåŠ¡é€»è¾‘è§£è€¦ï¼Œé™ä½ç³»ç»Ÿé—´çš„è€¦åˆï¼Œæé«˜ç³»ç»Ÿçš„å¥å£®æ€§ã€‚åç»­æœ‰å…¶ä»–ä¸šåŠ¡è¦ä½¿ç”¨è®¢å•æ•°æ®å¯ç›´æ¥è®¢é˜…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§ã€‚![nsqåº”ç”¨åœºæ™¯1](http://image.innoweb.cn/2020-02-07-190719.png)

### æµé‡å‰Šå³°

ç±»ä¼¼ç§’æ€ï¼ˆå¤§ç§’ï¼‰ç­‰åœºæ™¯ä¸‹ï¼ŒæŸä¸€æ—¶é—´å¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„è¯·æ±‚ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¤Ÿä¸ºåç«¯å¤„ç†è¯·æ±‚æä¾›ä¸€å®šçš„ç¼“å†²åŒºï¼Œä¿è¯åç«¯æœåŠ¡çš„ç¨³å®šæ€§ã€‚![nsqåº”ç”¨åœºæ™¯1](http://image.innoweb.cn/2020-02-07-190727.png)

## Kafka

### ä»‹ç» 

Kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®æµå¹³å°ï¼Œå¯ä»¥è¿è¡Œåœ¨å•å°æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨å¤šå°æœåŠ¡å™¨ä¸Šéƒ¨ç½²å½¢æˆé›†ç¾¤ã€‚å®ƒæä¾›äº†å‘å¸ƒå’Œè®¢é˜…åŠŸèƒ½ï¼Œä½¿ç”¨è€…å¯ä»¥å‘é€æ•°æ®åˆ°Kafkaä¸­ï¼Œä¹Ÿå¯ä»¥ä»Kafkaä¸­è¯»å–æ•°æ®(ä»¥ä¾¿è¿›è¡Œåç»­çš„å¤„ç†)ã€‚Kafkaå…·æœ‰é«˜ååã€ä½å»¶è¿Ÿã€é«˜å®¹é”™ç­‰ç‰¹ç‚¹ã€‚

Apache Kafkaç”±è‘—åèŒä¸šç¤¾äº¤å…¬å¸LinkedInå¼€å‘ï¼Œæœ€åˆæ˜¯è¢«è®¾è®¡ç”¨æ¥è§£å†³LinkedInå…¬å¸å†…éƒ¨æµ·é‡æ—¥å¿—ä¼ è¾“ç­‰é—®é¢˜ã€‚Kafkaä½¿ç”¨Scalaè¯­è¨€ ç¼–å†™ï¼Œäº201 1å¹´å¼€æºå¹¶è¿›å…¥Apacheå­µåŒ–å™¨ï¼Œ2012å¹´10æœˆæ­£å¼æ¯•ä¸šï¼Œ ç°åœ¨ä¸ºApacheé¡¶çº§é¡¹ç›®ã€‚

>  kafkaå°±ç›¸å½“äºæˆ‘ä»¬è¯´çš„queueé›†ç¾¤

### æ¦‚å¿µ

- Kafkaä½œä¸ºä¸€ä¸ªé›†ç¾¤ï¼Œè¿è¡Œåœ¨ä¸€å°æˆ–è€…å¤šå°æœåŠ¡å™¨ä¸Š.
- Kafka é€šè¿‡ *topic* å¯¹å­˜å‚¨çš„æµæ•°æ®è¿›è¡Œåˆ†ç±»ã€‚
- æ¯æ¡è®°å½•ä¸­åŒ…å«ä¸€ä¸ªkeyï¼Œä¸€ä¸ªvalueå’Œä¸€ä¸ªtimestampï¼ˆæ—¶é—´æˆ³ï¼‰ã€‚

### ç»„æˆ

![image-20200208033024243](http://image.innoweb.cn/2020-02-07-200508.png) 

- **Producer:** Producerå³ç”Ÿäº§è€…ï¼Œæ¶ˆæ¯çš„äº§ç”Ÿè€…,æ˜¯æ¶ˆæ¯çš„å…¥å£ã€‚

- **kafka cluster**: kafkaé›†ç¾¤ï¼Œ 1å°æˆ–å¤šå°æœåŠ¡å™¨ç»„æˆ

  - **Broker:** Brokeræ˜¯æŒ‡éƒ¨ç½²äº†Kafkaå®ä¾‹çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€‚æ¯ä¸ªæœåŠ¡å™¨.ä¸Šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªkafkaçš„å®ä¾‹ï¼Œæˆ‘ä»¬å§‘ä¸”è®¤ä¸ºæ¯ä¸ªbrokerå¯¹åº”1å°æœåŠ¡å™¨ã€‚æ¯ä¸ªkafkaé›†ç¾¤å†…çš„brokeréƒ½æœ‰1ä¸ªä¸é‡å¤çš„ç¼–å·ï¼Œå¦‚å›¾ä¸­çš„broker-0ã€broker-1ç­‰....

  - **Topic:** æ¶ˆæ¯çš„ä¸»é¢˜ï¼Œå¯ä»¥ç†è§£ä¸ºæ¶ˆæ¯çš„åˆ†ç±»ï¼Œkafkaçš„æ•°æ®å°±ä¿å­˜åœ¨topicã€‚ åœ¨æ¯ä¸ªbrokerä¸Šéƒ½å¯ä»¥åˆ›å»ºå¤šä¸ªtopicã€‚å®é™…åº”ç”¨ä¸­é€šå¸¸æ˜¯ä¸€ä¸ªä¸šåŠ¡çº¿å»ºä¸€ä¸ªtopicã€‚

  - **Partition:** Topicçš„åˆ†åŒºï¼Œ æ¯ä¸ªtopicå¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºï¼Œåˆ†åŒºçš„ä½œç”¨æ˜¯åšè´Ÿè½½ï¼Œæé«˜kafkaçš„ååé‡ã€‚åŒä¸€ä¸ªtopicåœ¨ä¸åŒçš„åˆ†åŒºçš„æ•°æ®æ˜¯ä¸é‡å¤çš„ï¼Œpartitionçš„è¡¨ç°å½¢å¼å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ–‡ä»¶å¤¹!

  - **Replication**:æ¯ä¸€ä¸ªåˆ†åŒºéƒ½æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå‰¯æœ¬çš„ä½œç”¨æ˜¯åšå¤‡èƒã€‚å½“ä¸»åˆ†åŒº(Leader) æ•…éšœçš„æ—¶å€™ä¼šé€‰æ‹©ä¸€ä¸ªå¤‡èƒ(Follower), ä¸Šä½ï¼Œ æˆä¸ºLeaderã€‚ åœ¨kafkaä¸­é»˜è®¤å‰¯æœ¬çš„æœ€å¤§æ•°é‡æ˜¯10ä¸ªï¼Œä¸”å‰¯æœ¬çš„æ•°é‡ä¸èƒ½å¤§äºBrokerçš„æ•°é‡ï¼Œfollowerå’Œleaderç»å¯¹æ˜¯ åœ¨ä¸åŒçš„æœºå™¨ï¼ŒåŒä¸€æœºå™¨å¯¹åŒä¸€ä¸ªåˆ†åŒºä¹Ÿåªå¯èƒ½å­˜æ”¾ä¸€ä¸ªå‰¯æœ¬(åŒ…æ‹¬è‡ªå·±)ã€‚ 

- **Consumer**:æ¶ˆè´¹è€…ï¼Œå³æ¶ˆæ¯çš„æ¶ˆè´¹æ–¹ï¼Œæ˜¯æ¶ˆæ¯çš„å‡ºå£ã€‚
  - **Consumer Group:**æˆ‘ä»¬å¯ä»¥å°†å¤šä¸ªæ¶ˆè´¹ç»„ç»„æˆä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œåœ¨kafkaçš„è®¾è®¡ä¸­åŒä¸€ä¸ªåˆ†åŒºçš„æ•°æ®åªèƒ½è¢«æ¶ˆè´¹è€…ç»„ä¸­çš„æŸ1ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒ1ä¸ªtopicçš„ä¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†æé«˜kafkaçš„ååé‡!

### å·¥ä½œæµç¨‹

æˆ‘ä»¬çœ‹ä¸Šé¢çš„æ¶æ„å›¾ä¸­ï¼Œproducerå°±æ˜¯ç”Ÿäº§è€…ï¼Œ æ˜¯æ•°æ®çš„å…¥å£ã€‚Produceråœ¨å†™ å…¥æ•°æ®çš„æ—¶å€™ä¼šæŠŠæ•°æ®å†™å…¥åˆ°leaderä¸­ï¼Œä¸ä¼šç›´æ¥å°†æ•°æ®å†™å…¥follower!é‚£leaderæ€ ä¹ˆæ‰¾å‘¢?å†™å…¥çš„æµç¨‹åˆæ˜¯ä»€ä¹ˆæ ·çš„å‘¢?æˆ‘ä»¬çœ‹ä¸‹å›¾:

![image-20200208033937292](http://image.innoweb.cn/2020-02-07-193940.png) 

1. ç”Ÿäº§è€…ä»Kafkaé›†ç¾¤è·å–åˆ†åŒºleaderä¿¡æ¯ 

2. ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™leader

3. leaderå°†æ¶ˆæ¯å†™å…¥æœ¬åœ°ç£ç›˜

4. followerä»leaderæ‹‰å–æ¶ˆæ¯æ•°æ® 

5. followerå°†æ¶ˆæ¯å†™å…¥æœ¬åœ°ç£ç›˜åå‘leaderå‘é€ACK

6. leaderæ”¶åˆ°æ‰€æœ‰çš„followerçš„ACKä¹‹åå‘ç”Ÿäº§è€…å‘é€ACK

### é€‰æ‹©partitionçš„åŸåˆ™

é‚£åœ¨kafkaä¸­ï¼Œå¦‚æœæŸä¸ªtopicæœ‰å¤šä¸ªpartition, produceråˆæ€ä¹ˆçŸ¥é“è¯¥å°†æ•°æ®å‘å¾€å“ªä¸ªpartitionå‘¢?kafkaä¸­æœ‰å‡ ä¸ªåŸåˆ™:

1. partitionåœ¨å†™å…¥çš„æ—¶å€™å¯ä»¥æŒ‡å®šéœ€è¦å†™å…¥çš„partition, å¦‚æœæœ‰æŒ‡å®šï¼Œåˆ™å†™å…¥å¯¹åº”çš„partitionã€‚

2. å¦‚æœæ²¡æœ‰æŒ‡å®špartition, ä½†æ˜¯è®¾ç½®äº†æ•°æ®çš„key,åˆ™ä¼šæ ¹æ®keyçš„å€¼hashå‡º- - -ä¸ªpartitionã€‚ 

3. å¦‚æœæ—¢æ²¡æŒ‡å®špartition, åˆæ²¡æœ‰è®¾ç½®key,åˆ™ä¼šé‡‡ç”¨è½®è¯¢æ–¹å¼ï¼Œå³æ¯æ¬¡å–-å°æ®µæ—¶é—´çš„æ•°æ®å†™å…¥æŸä¸ªpartitionï¼Œä¸‹ä¸€å°æ®µçš„æ—¶é—´å†™å…¥ä¸‹ä¸€ä¸ªpartitionã€‚

> å‰ææ˜¯æˆ‘ä»¬è®¾ç½®äº†å¤šä¸ªpartitionã€‚

### ACKåº”ç­”æœºåˆ¶

produceråœ¨å‘kafkaå†™å…¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®å‚æ•°æ¥ç¡®å®šæ˜¯å¦ç¡®è®¤kafkaæ¥æ”¶åˆ°æ•°æ®ï¼Œè¿™ä¸ªå‚æ•°å¯è®¾ç½®çš„å€¼ä¸º`0ã€1ã€all`ã€‚

- 0ä»£è¡¨producerå¾€é›†ç¾¤å‘é€æ•°æ®ä¸éœ€è¦ç­‰åˆ°é›†ç¾¤çš„è¿”å›ï¼Œä¸ç¡®ä¿æ¶ˆæ¯å‘é€æˆåŠŸã€‚å®‰å…¨æ€§æœ€ä½ä½†æ˜¯æ•ˆç‡æœ€é«˜ã€‚

- 1ä»£è¡¨producerå¾€é›†ç¾¤å‘é€æ•°æ®åªè¦leaderåº”ç­”å°±å¯ä»¥å‘é€ä¸‹ä¸€ æ¡ï¼Œåªç¡®ä¿leaderæ¥æ”¶æˆåŠŸã€‚

- allä»£è¡¨producerå¾€é›† ç¾¤å‘é€æ•°æ®éœ€è¦æ‰€æœ‰çš„followeréƒ½å®Œæˆä»leaderçš„åŒæ­¥æ‰ä¼šå‘é€ä¸‹ä¸€æ¡,ç¡®ä¿leaderå‘é€æˆåŠŸå’Œæ‰€æœ‰çš„å‰¯æœ¬éƒ½å®Œæˆå¤‡ä»½ã€‚å®‰å…¨æ€§æœ€é«˜ï¼Œä½†æ˜¯æ•ˆç‡æœ€ä½ã€‚

> æœ€åè¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¾€ä¸å­˜åœ¨çš„topicå†™æ•°æ®ï¼Œkafkaä¼š è‡ªåŠ¨åˆ›å»ºtopic, partitionå’Œreplicationçš„æ•°é‡é»˜è®¤é…ç½®éƒ½æ˜¯1ã€‚ 

### Topicå’Œæ•°æ®æ—¥å¿—

topicæ˜¯åŒ1ç±»åˆ«çš„æ¶ˆæ¯è®°å½•(record) çš„é›†åˆã€‚åœ¨Kafkaä¸­ï¼Œ ä¸€ä¸ªä¸»é¢˜é€šå¸¸æœ‰å¤šä¸ªè®¢é˜…è€…ã€‚å¯¹äºæ¯ä¸ªä¸»é¢˜ï¼ŒKafkaé›†ç¾¤ç»´æŠ¤äº†ä¸€ä¸ªåˆ†åŒºæ•°æ®æ—¥å¿—æ–‡ä»¶ç»“æ„å¦‚ä¸‹:

![image-20200208034618236](http://image.innoweb.cn/2020-02-07-194622.png)

 

æ¯ä¸ªpartitionéƒ½æ˜¯ä¸€ä¸ªæœ‰åºå¹¶ä¸”ä¸å¯å˜çš„æ¶ˆæ¯è®°å½•é›†åˆã€‚å½“æ–°çš„æ•°æ®å†™å…¥æ—¶ï¼Œå°±è¢«è¿½åŠ åˆ°partitionçš„æœ«å°¾ã€‚åœ¨æ¯ä¸ªpartitionä¸­ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªé¡ºåºçš„å”¯ä¸€ æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†è¢«ç§°ä¸ºoffset, å³åç§»é‡ã€‚æ³¨æ„ï¼ŒKafkaåªä¿è¯åœ¨åŒä¸€ä¸ªpartitionå†…éƒ¨æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼Œåœ¨ä¸åŒpartitionä¹‹é—´ï¼Œå¹¶ä¸èƒ½ä¿è¯æ¶ˆæ¯æœ‰åºã€‚

### Partitionç»“æ„ 

Partitionåœ¨æœåŠ¡å™¨ä¸Šçš„è¡¨ç°å½¢å¼å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä½ç½®ä¸ºkafkaä¸­é…ç½®çš„ä½ç½®ï¼Œæ¯ä¸ªpartitionçš„æ–‡ä»¶å¤¹ä¸‹é¢ä¼šæœ‰å¤šç»„segmentæ–‡ä»¶ï¼Œæ¯ç»„segmentæ–‡ä»¶åˆåŒ…å«. indexæ–‡ä»¶ã€. 1ogæ–‡ä»¶ã€. timeindexæ–‡ä»¶ä¸‰ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­.1ogæ–‡ä»¶å°±æ˜¯å®é™…å­˜å‚¨messageçš„åœ°æ–¹ï¼Œè€Œ. indexå’Œ. timeindexæ–‡ä»¶ä¸ºç´¢å¼•æ–‡ä»¶ï¼Œç”¨äºæ£€ç´¢æ¶ˆæ¯ã€‚

<img src="http://image.innoweb.cn/2020-02-07-225239.png" alt="image-20200208065231973" style="zoom:50%;" />

### æ¶ˆè´¹æ•°æ®

å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹å¯ä»¥ç»„æˆä¸€ä»‹æ¶ˆè´¹è€…ç»„ï¼Œå¹¶ç”¨ä¸€ä¸ªæ ‡ç­¾æ¥æ ‡è¯†è¿™ä¸ªæ¶ˆè´¹è€…ç»„ã€‚

ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„ä¸åŒæ¶ˆè´¹è€…å®ä¾‹å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ç”šè‡³ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚

 å¦‚æœæ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹éƒ½åœ¨åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­ï¼Œé‚£ä¹ˆæ¶ˆæ¯è®°å½•ä¼šè¢«å¾ˆå¥½çš„å‡è¡¡çš„å‘é€åˆ°æ¯ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚

å¦‚æœæ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹éƒ½åœ¨ä¸åŒçš„æ¶ˆè´¹è€…ç»„ï¼Œé‚£ä¹ˆæ¯ä¸€æ¡æ¶ˆæ¯è®°å½•ä¼šè¢«å¹¿æ’­åˆ°æ¯1ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚

![image-20200208035228677](http://image.innoweb.cn/2020-02-07-200443.png)

 

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºä¸€ä¸ªä¸¤ä¸ªèŠ‚ç‚¹çš„Kafkaé›†ç¾¤ä¸Šæ‹¥æœ‰-ä¸ªå››ä¸ªpartition (PO-P3) çš„topicã€‚ æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…ç»„éƒ½åœ¨æ¶ˆè´¹è¿™ä¸ªtopicä¸­çš„æ•°æ®ï¼Œæ¶ˆè´¹è€…ç»„Aæœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼Œæ¶ˆè´¹è€…ç»„Bæœ‰å››ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…å®ä¾‹å¯ä»¥æ¶ˆè´¹å¤šä¸ªåˆ†åŒºï¼Œä½†æ˜¯æ¯ä¸ªåˆ†åŒºæœ€å¤šåªèƒ½è¢«æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªå®ä¾‹æ¶ˆè´¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰ä¸€ä¸ª4ä¸ªåˆ†åŒºçš„ä¸»é¢˜ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…ç»„ä¸­æœ€å¤šåªèƒ½æœ‰4ä¸ªæ¶ˆè´¹è€…å®ä¾‹å»æ¶ˆè´¹ï¼Œå¤šå‡ºæ¥çš„éƒ½ä¸ä¼šè¢«åˆ†é…åˆ°åˆ†åŒºã€‚å…¶å®è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå¦‚æœå…è®¸ä¸¤ä¸ªæ¶ˆè´¹è€…å®ä¾‹åŒæ—¶æ¶ˆè´¹åŒä¸€ä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆå°±æ— æ³•è®°å½•è¿™ä¸ªåˆ†åŒºè¢«è¿™ä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹çš„offsetäº†ã€‚å¦‚æœåœ¨æ¶ˆè´¹è€…ç»„ä¸­åŠ¨æ€çš„ä¸Šçº¿æˆ–ä¸‹çº¿æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆKafkaé›†ç¾¤ä¼šè‡ªåŠ¨è°ƒæ•´åˆ†åŒºä¸æ¶ˆè´¹è€…å®ä¾‹é—´çš„å¯¹åº”å…³ç³»ã€‚

### Kafkaæœ‰å››ä¸ªæ ¸å¿ƒçš„API:

- The [Producer API](http://kafka.apachecn.org/documentation.html#producerapi) å…è®¸ä¸€ä¸ªåº”ç”¨ç¨‹åºå‘å¸ƒä¸€ä¸²æµå¼çš„æ•°æ®åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªKafka topicã€‚
- The [Consumer API](http://kafka.apachecn.org/documentation.html#consumerapi) å…è®¸ä¸€ä¸ªåº”ç”¨ç¨‹åºè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ª topic ï¼Œå¹¶ä¸”å¯¹å‘å¸ƒç»™ä»–ä»¬çš„æµå¼æ•°æ®è¿›è¡Œå¤„ç†ã€‚
- The [Streams API](http://kafka.apachecn.org/documentation/streams) å…è®¸ä¸€ä¸ªåº”ç”¨ç¨‹åºä½œä¸ºä¸€ä¸ª*æµå¤„ç†å™¨*ï¼Œæ¶ˆè´¹ä¸€ä¸ªæˆ–è€…å¤šä¸ªtopicäº§ç”Ÿçš„è¾“å…¥æµï¼Œç„¶åç”Ÿäº§ä¸€ä¸ªè¾“å‡ºæµåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªtopicä¸­å»ï¼Œåœ¨è¾“å…¥è¾“å‡ºæµä¸­è¿›è¡Œæœ‰æ•ˆçš„è½¬æ¢ã€‚
- The [Connector API](http://kafka.apachecn.org/documentation.html#connect) å…è®¸æ„å»ºå¹¶è¿è¡Œå¯é‡ç”¨çš„ç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…ï¼Œå°†Kafka topicsè¿æ¥åˆ°å·²å­˜åœ¨çš„åº”ç”¨ç¨‹åºæˆ–è€…æ•°æ®ç³»ç»Ÿã€‚æ¯”å¦‚ï¼Œè¿æ¥åˆ°ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼Œæ•æ‰è¡¨ï¼ˆtableï¼‰çš„æ‰€æœ‰å˜æ›´å†…å®¹ã€‚

### Kafkaé…ç½®

```properties
############################# Server Basics #############################
#	broker id kafkaåœ¨é›†ç¾¤é‡Œçš„broker id
broker.id=0

############################# Log Basics #############################
# A comma separated list of directories under which to store log filesï¼Œæ—¥å¿—æ–‡ä»¶å¤¹
log.dirs=/usr/local/var/lib/kafka-logs

# the brokers. partitionåˆ†åŒºæ•°
num.partitions=1

############################# Zookeeper #############################
# Zookeeper connection string (see zookeeper docs for details). zookkeeper ç«¯å£
zookeeper.connect=localhost:2181

# Timeout in ms for connecting to zookeeper
zookeeper.connection.timeout.ms=6000
```

### å‘½ä»¤è¡Œ

å¯åŠ¨

```bash
zookeeper-server-start /usr/local/etc/kafka/zookeeper.properties & kafka-server-start /usr/local/etc/kafka/server.properties
```

å°†æ¶ˆè´¹æ‰“åˆ°å‘½ä»¤è¡Œ

```bash
kafka-console-consumer --bootstrap-server=127.0.0.1:9092 --topic=web_log --from-beginning
```



## goæ“ä½œkafka

### sarama

Goè¯­è¨€ä¸­è¿æ¥kafkaä½¿ç”¨ç¬¬ä¸‰æ–¹åº“:[github.com/Shopify/sarama](https://github.com/Shopify/sarama)ã€‚

### ä¸‹è½½åŠå®‰è£…

```bash
go get github.com/Shopify/sarama
```

### æ³¨æ„äº‹é¡¹

`sarama` v1.20ä¹‹åçš„ç‰ˆæœ¬åŠ å…¥äº†`zstd`å‹ç¼©ç®—æ³•ï¼Œéœ€è¦ç”¨åˆ°cgoï¼Œåœ¨Windowså¹³å°ç¼–è¯‘æ—¶ä¼šæç¤ºç±»ä¼¼å¦‚ä¸‹é”™è¯¯ï¼š

```bash
# github.com/DataDog/zstd
exec: "gcc":executable file not found in %PATH%
```

æ‰€ä»¥åœ¨Windowså¹³å°è¯·ä½¿ç”¨v1.19ç‰ˆæœ¬çš„saramaã€‚

### è¿æ¥kafkaå‘é€æ¶ˆæ¯

```go
import (
	"fmt"
	"github.com/Shopify/sarama"
)

var (
	client sarama.SyncProducer
)

///

func Init(addrs ...string) (err error) {
	//é…ç½®kafka
	config := sarama.NewConfig()  //ç”Ÿæˆé…ç½®é€šè¿‡å±æ€§èµ‹å€¼çš„æ–¹å¼ä¿®æ”¹
	config.Producer.RequiredAcks = sarama.WaitForAll
	// å¯¹åº”kafkaçš„åº”ç­”æœºåˆ¶çš„ä¸‰ä¸ªçŠ¶æ€ç ï¼Œè¿™é‡Œæˆ‘ä»¬ç­‰å¾…æ‰€æœ‰çš„followeréƒ½åŒæ­¥å®Œæˆä¹‹åproducerå†å‘é€ä¸‹ä¸€æ¡ã€‚
	config.Producer.Partitioner = sarama.NewRandomPartitioner
	// ä»¥è½®è¯¢çš„æ–¹å¼éšæœºå†™å…¥partitioner
	config.Producer.Return.Successes = true
	// æˆåŠŸäº¤ä»˜çš„ä¿¡æ¯å†channelä¸­è¿”å›

	client, err = sarama.NewSyncProducer(addrs,config)
	// è¿™é‡Œæ¥å—ä¸€ä¸ªipåœ°å€çš„åˆ‡ç‰‡ï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªé›†ç¾¤
	if err != nil {
		fmt.Println("Producer closed, err:", err)
		return
	}
	return
}

func SendToKafka(topic, data string) {
	//æ„é€ æ¶ˆæ¯
	msg := &sarama.ProducerMessage{}
	msg.Topic = topic
	msg.Value = sarama.StringEncoder(data)

	//å‘é€æ¶ˆæ¯
	pid, offset, err := client.SendMessage(msg)
	if err != nil {
		fmt.Println("send msg failed, err:",err)
	}
	fmt.Printf("pid: %v	offset: %v\n", pid, offset)
}
//main.go
func main(){
	err = kafka.Init([]string{cfg.Address}...)
	if err != nil {
		fmt.Printf("Init kafka fail, err:%v",err)
		return
	}
	for {
		select {
			case line := <-tailLog.ReadLog():
				kafka.SendToKafka(topic,line.Text)
			default:
				time.Sleep(time.Second)
		}
	}
}
```
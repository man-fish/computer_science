![DraggedImage](http://image.innoweb.cn/2020-02-08-193104.png)

## 简介

etcd是一个分布式一致性键值存储系统，用于共享配置和服务发现，专注于：

- 简单：良好定义的，面向用户的**API (gRPC)**。

- 安全：带有可选客户端证书认证的自动**TLS**。

- 快速：测试验证，每秒**10000**写入。

- 可靠：使用**Raft**适当分布。

**etcd**是Go编写，并使用**Raft**一致性算法来管理高可用复制日志，架构如下图所示：

<img src="http://image.innoweb.cn/2020-02-08-192736.png" alt="image-20200209032726856" style="zoom:50%;" />

## Raft

选举，日志复制机制，异常处理。

### 分布式锁

因为etcd使用Raft[算法](https://link.jianshu.com?t=http://lib.csdn.net/base/datastructure)保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。

·保持独占，即所有试图获取锁的用户最终只有一个可以得到。etcd为此提供了一套实现分布式锁原子操作CAS（CompareAndSwap）的API。通过设置prevExist值，可以保证在多个节点同时创建某个目录时，只有一个成功，而该用户即可认为是获得了锁。

·控制时序，即所有试图获取锁的用户都会进入等待队列，获得锁的顺序是全局唯一的，同时决定了队列执行顺序。etcd为此也提供了一套API（自动创建有序键），对一个目录建值时指定为POST动作，这样etcd会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用API按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。

<img src="http://image.innoweb.cn/2020-02-08-195013.png" alt="image-20200209034958508" style="zoom:60%;" />


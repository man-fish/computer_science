# Trojan基本原理

首先国内网络审查的方式就是 `GFW`，而 `GFW` 并非禁止所有流量出境，而是会对出境流量进行审查，所以说我们可以通过代理服务器的方式访问无法访问的网站，代理服务器的地址通常是合法的，为了防止`GFW`对我们发给代理服务器报文的检查，加密协议是必须的，根据加密协议的不同就衍生出了几种不同的代理网络框架：

## 为什么（使用流密码的）Shadowsocks容易遭到封锁

防火墙在早期仅仅只是对出境流量进行截获和审查，也即被动检测。`Shadowsocks`的加密协议设计使得传输的数据包本身几乎没有任何特征，看起来类似于完全随机的比特流，这在早期的确能有效绕过`GFW`。

目前的`GFW`已经开始采用主动探测的方式。具体来说，当`GFW`发现一个可疑的无法识别的连接时（大流量，随机字节流，高位端口等特征），将会主动连接这个服务器端口，重放之前捕获到的流量（或者经过一些精心修改后重放）。`Shadowsocks`服务器检测到不正常的连接，将连接断开。这种不正常的流量和断开连接的行为被视作可疑的`Shadowsocks`服务器的特征，于是该服务器被加入`GFW`的可疑名单中。这个名单不一定立即生效，而是在某些特殊的敏感时期，可疑名单中的服务器会遭到暂时或者永久的封锁。该可疑名单是否封锁，可能由人为因素决定。

如果你想了解更多，可以参考[这篇文章](https://gfw.report/blog/gfw_shadowsocks/)。

## Trojan如何绕过GFW

与`Shadowsocks`相反，`Trojan`不使用自定义的加密协议来隐藏自身。相反，使用特征明显的`TLS`协议`(TLS/SSL)`，使得流量看起来与正常的`HTTPS`网站相同。`TLS`是一个成熟的加密体系，`HTTPS`即使用`TLS`承载`HTTP`流量。使用正确配置的加密`TLS`隧道，可以保证传输的

+ 保密性（GFW无法得知传输的内容）
+ 完整性（一旦GFW试图篡改传输的密文，通讯双方都会发现）
+ 不可抵赖（GFW无法伪造身份冒充服务端或者客户端）
+ 前向安全（即使密钥泄露，GFW也无法解密先前的加密流量）

对于被动检测，`Trojan`协议的流量与`HTTPS`流量的特征和行为完全一致。而`HTTPS`流量占据了目前互联网流量的一半以上，且`TLS`握手成功后流量均为密文，几乎不存在可行方法从其中分辨出`Trojan`协议流量。

对于主动检测，当防火墙主动连接`Trojan`服务器进行检测时，`Trojan`可以正确识别非`Trojan`协议的流量。与`Shadowsocks`等代理不同的是，此时`Trojan`不会断开连接，而是将这个连接代理到一个正常的`Web`服务器。在`GFW`看来，该服务器的行为和一个普通的`HTTPS`网站行为完全相同，无法判断是否是一个`Trojan`代理节点。这也是`Trojan`推荐使用合法的域名、使用权威`CA`签名的`HTTPS`证书的原因: 这让你的服务器完全无法被`GFW`使用主动检测判定是一个`Trojan`服务器。

因此，就目前的情况来看，若要识别并阻断`Trojan`的连接，只能使用无差别封锁（封锁某个`IP`段，某一类证书，某一类域名，甚至阻断全国所有出境`HTTPS`连接）或发动大规模的中间人攻击（劫持所有`TLS`流量并劫持证书，审查内容）。对于中间人攻击，可以使用`Websocket`的双重`TLS`应对。